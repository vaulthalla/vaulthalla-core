#!/usr/bin/env bash
set -e

# 1) Create system user + group
id vaulthalla &>/dev/null || sudo useradd -r -s /usr/sbin/nologin vaulthalla

# 2) Layout dirs
sudo install -d -o vaulthalla -g vaulthalla -m 755 /mnt/vaulthalla
sudo install -d -o vaulthalla -g vaulthalla -m 755 /var/lib/vaulthalla
sudo install -d -o vaulthalla -g vaulthalla -m 750 /var/log/vaulthalla
sudo install -d -o vaulthalla -g vaulthalla -m 755 /run/vaulthalla

# 3) Drop binaries
sudo install -m 755 build/vaulthalla_fuse_daemon /usr/local/bin/
sudo install -m 755 build/vaulthalla_cli         /usr/local/bin/

# 4) Copy default config
sudo install -d -m 755 /etc/vaulthalla
sudo cp packaging/default.toml /etc/vaulthalla/vaulthalla.toml

# 5) Create database and db user
VAUL_PG_PASS=$(uuidgen)       # generate a random password
sudo -u postgres psql <<EOF
DO \$\$
BEGIN
    IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'vaulthalla') THEN
        CREATE USER vaulthalla WITH PASSWORD '${VAUL_PG_PASS}';
    END IF;

    IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'vaulthalla') THEN
        CREATE DATABASE vaulthalla OWNER vaulthalla;
    END IF;
END
\$\$;
GRANT ALL PRIVILEGES ON DATABASE vaulthalla TO vaulthalla;
EOF

# 6) Init the database schema

# 7) Update database config with generated password
sed -i "s/^\(password:\s*\).*\(#.*\)/\1${VAUL_PG_PASS} \2/" /etc/vaulthalla/config.yaml

# Done
echo "[+] Vaulthalla installed. Enable the systemd unit and you're golden."
