#!/bin/sh
set -e

# postinst for vaulthalla
# - Creates system user/group + runtime dirs
# - (Optional) initializes PostgreSQL role/db
# - Seeds super-admin UID to /run for runtime consumption
# - Seeds DB password to /run for runtime TPM sealing
# - Does NOT write secrets to /etc/vaulthalla/config.yaml
#
# Depends (in debian/control): postgresql, openssl

. /usr/share/debconf/confmodule

PKG="vaulthalla"
DB_USER="vaulthalla"
DB_NAME="vaulthalla"

# ---------- helpers ----------

create_dir() {
    # create_dir path mode owner group
    install -d -m "$2" -o "$3" -g "$4" "$1"
}

psql_q() {
    # psql_q "SQL" [database]
    sudo -u postgres psql -X -v ON_ERROR_STOP=1 -tAc "$1" "${2:-postgres}"
}

ensure_tss_group_and_user_added() {
    if getent group tss > /dev/null; then
        echo "ðŸ”‘ Adding 'vaulthalla' to existing 'tss' group..."
    else
        echo "âš ï¸ No 'tss' group found, creating one..."
        addgroup --system tss
    fi
    adduser vaulthalla tss
}

# ---------- main ----------

case "$1" in
  configure)
    # System user/group
    if ! id "$DB_USER" >/dev/null 2>&1; then
        adduser --quiet --system --group --home /nonexistent --no-create-home --shell /usr/sbin/nologin "$DB_USER"
    fi

    systemd-tmpfiles --create /usr/lib/tmpfiles.d/vaulthalla.conf || true

    ensure_tss_group_and_user_added

    # Runtime/state dirs
    create_dir /var/lib/vaulthalla 0755 "$DB_USER" "$DB_USER"
    create_dir /var/log/vaulthalla 0750 "$DB_USER" "$DB_USER"
    create_dir /run/vaulthalla     0700 "$DB_USER" "$DB_USER"
    install -d -m 0755 /etc/vaulthalla
    [ -d /mnt/vaulthalla ] || create_dir /mnt/vaulthalla 0755 "$DB_USER" "$DB_USER"

    # --- Debconf: initialize database? ---
    db_get vaulthalla/init-db || true
    INIT_DB="${RET:-true}"

    if [ "$INIT_DB" = "true" ]; then
        echo "[${PKG}] Setting up PostgreSQL role/databaseâ€¦"

        ROLE_EXISTS="$(psql_q "SELECT 1 FROM pg_roles WHERE rolname='${DB_USER}'")"
        DB_EXISTS="$(psql_q "SELECT 1 FROM pg_database WHERE datname='${DB_NAME}'")"

        VAUL_PG_PASS="$(openssl rand -base64 32 | tr -d '\n')"

        if [ "$ROLE_EXISTS" != "1" ]; then
            sudo -u postgres psql -X -v ON_ERROR_STOP=1 postgres <<EOF
CREATE ROLE ${DB_USER} LOGIN PASSWORD '${VAUL_PG_PASS}';
EOF
            echo "[${PKG}] Created role '${DB_USER}'."
        else
            echo "[${PKG}] Role '${DB_USER}' already exists."
        fi

        if [ "$DB_EXISTS" != "1" ]; then
            sudo -u postgres psql -X -v ON_ERROR_STOP=1 \
              -c "CREATE DATABASE ${DB_NAME} OWNER ${DB_USER};" postgres
            echo "[${PKG}] Created database '${DB_NAME}'."
        else
            echo "[${PKG}] Database '${DB_NAME}' already exists."
        fi

        # Harmless if owner already
        sudo -u postgres psql -X -v ON_ERROR_STOP=1 \
          -c "GRANT ALL PRIVILEGES ON DATABASE ${DB_NAME} TO ${DB_USER};" postgres

        # Seed DB password (for runtime TPM sealing)
        PENDING_DB_PASS_FILE="/run/vaulthalla/db_password"
        umask 077
        printf '%s\n' "$VAUL_PG_PASS" > "$PENDING_DB_PASS_FILE"
        chown "$DB_USER:$DB_USER" "$PENDING_DB_PASS_FILE"
        echo "[${PKG}] Seeded DB password to ${PENDING_DB_PASS_FILE} (mode 600)."
    else
        echo "[${PKG}] Skipping PostgreSQL initialization per user choice."
    fi

    systemctl --system daemon-reexec
    systemctl --system daemon-reload
    systemctl --system preset vaulthalla.service >/dev/null || true
    systemctl --system preset vaulthalla-cli.socket >/dev/null || true
    systemctl --system preset vaulthalla-cli.service >/dev/null || true

    #DEBHELPER#
    ;;

  abort-upgrade|abort-remove|abort-deconfigure)
    #DEBHELPER#
    ;;

  *)
    echo "postinst called with unknown argument \`$1'" >&2
    exit 1
    ;;
esac

exit 0
